function e(e){return{type:"#text",properties:{textContent:e},children:[]}}function t(t,r,n){r&&"string"!=typeof r&&!Array.isArray(r)||(n=r,r={}),"string"==typeof n?n=[n]:Array.isArray(n)||(n=[]);return{type:t,properties:r,children:n.map(t=>"string"==typeof t?e(t):t)}}var r=Object.freeze({__proto__:null,createText:e,createFragment:function(...e){return{type:"#document-fragment",properties:{},children:e}},createNode:t,createComment:function(e){return{type:"#comment",properties:{textContent:e},children:[]}}});function n(e,r=!1){const o=e.nodeName.toLocaleLowerCase(),s={};if(e instanceof Element)for(const{name:t,value:r}of e.attributes)s[t]=r;else s.textContent=e.textContent||"";let i=[...e.childNodes].map(e=>n(e,r));return r&&(i=i.filter(e=>!["#text","#comment"].includes(e.type)||!/^\s*$/.test(e.properties.textContent))),t(o,s,i)}class o{constructor(){this._renderMap=new Map,this._oldVirdNodeMap=new Map,this._nodeMap=new WeakMap,this._virdNodeMap=new WeakMap,this._nodeCreatorMap=new WeakMap,this._propertyTypeBinderMap=new Map,this._propertyTypeRegExpBinderMap=new Map,this._customNodeCreatorMap=new Map,this.fragmentType="#document-fragment",this.setCustomNode("#text",()=>document.createTextNode("")),this.setCustomNode("#comment",()=>document.createComment("")),this.setCustomNode("#cdata-section",()=>document.createCDATASection("")),this.setPropertyTypeBind("textContent",(e,t)=>{e.textContent=t.newValue||""})}_updateNode(e,t,r){const n=function(e,t){const r={};if(e!==t)if(e)if(t){const n=Object.keys(e),o=Object.keys(t),s=new Set([...n,...o]);for(const n of s){const o=e[n],s=t[n];o!==s&&(r[n]=[o,s])}}else for(const t of Object.keys(e)){const n=e[t];r[t]=[n,void 0]}else if(t)for(const e of Object.keys(t)){const n=t[e];r[e]=[void 0,n]}return r}(t,r);for(const t of Object.keys(n)){const[r,o]=n[t];let s=!1;for(const[n,i]of this._propertyTypeRegExpBinderMap){const p=t.match(n);if(p){s=!0,i(e,p,{newValue:r,oldValue:o});break}}if(!s){const n=this._propertyTypeBinderMap.get(t);n?n(e,{newValue:r,oldValue:o}):e instanceof Element&&(r?e.setAttribute(t,r):e.removeAttribute(t))}}}render(e,...t){const r=function e(t,r="#document-fragment"){const n=[];for(const o of t)if(o.type===r){const t=e(o.children);n.push(...t)}else n.push(o);return n}(t.map(t=>"function"==typeof t?t(e):t)),n=this.getChildrenVirdNode(e),o=[...e.childNodes];this._renderMap.set(e,t),this._oldVirdNodeMap.set(e,r);let s=0;const i=Math.max(o.length,r.length);for(;s<i;){const t=n[s]||null,i=r[s]||null,p=o[s]||null;let d=null;i?t&&t.type===i.type?d=p:(d=this.createNode(i),p?e.replaceChild(d,p):e.appendChild(d)):p&&e.removeChild(p),d&&(this._updateNode(d,i?i.properties:void 0,t?t.properties:void 0),i&&i.children.length>0&&this.render(d,...i.children)),s++}return r}renderDom(e,t=!1){const r=n(e,t).children;return this.render(e,...r)}reRender(e){const t=this._renderMap.get(e);t&&this.render(e,...t)}createDispatcher(e){return async t=>{t&&await t(),this.reRender(e)}}createEffect(e,t,r){const n=this.createDispatcher(e);return{value:r,setEffect(e){n(async()=>{this.value=await t(e)})}}}createNode(e){let t;const r=this._nodeMap.get(e);r&&(t=r);const n=t?this._nodeCreatorMap.get(t):void 0,o=this._customNodeCreatorMap.get(e.type);return n!==o&&o&&(t=o(e)),t||(t=document.createElement(e.type)),this._nodeMap.set(e,t),this._virdNodeMap.set(t,e),t}clone(){const e=new o;for(const[t,r]of this._propertyTypeRegExpBinderMap)e.setPropertyTypeRegExpBind(t,r);for(const[t,r]of this._propertyTypeBinderMap)e.setPropertyTypeBind(t,r)}getNode(e){return this._nodeMap.get(e)||null}getVirdNode(e){return this._virdNodeMap.get(e)||null}getChildrenVirdNode(e){return this._oldVirdNodeMap.get(e)||[]}setCustomNode(e,t){return this._customNodeCreatorMap.set(e,t),this}removeCustomNode(e){return this._customNodeCreatorMap.delete(e),this}setPropertyTypeRegExpBind(e,t){return this.removePropertyTypeRegExpBind(e),this._propertyTypeRegExpBinderMap.set(e,t),this}removePropertyTypeRegExpBind(e){for(const t of this._propertyTypeRegExpBinderMap.keys())if(String(t)===String(e)){this._propertyTypeRegExpBinderMap.delete(e);break}return this}setPropertyTypeBind(e,t){return this._propertyTypeBinderMap.set(e,t),this}removePropertyTypeBind(e){return this._propertyTypeBinderMap.delete(e),this}}const s=new o;var i=Object.freeze({__proto__:null,Renderer:o,renderer:s,createNode:n});export{r as Vird,i as VirdDom};
