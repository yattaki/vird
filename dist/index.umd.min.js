!function(e,t){"object"==typeof exports&&"undefined"!=typeof module?t(exports):"function"==typeof define&&define.amd?define(["exports"],t):t((e=e||self).vird={})}(this,(function(e){"use strict";const t=Object.defineProperties({},{text:{value:"#text"},comment:{value:"#comment"},fragment:{value:"#document-fragment"}});function n(e,r=!1){return{type:t.text,properties:Object.assign({},e.properties),children:r?e.children.map(e=>n(e)):[]}}function r(e=""){return{type:t.text,properties:{textContent:e},children:[]}}function s(e,t,n){let s;return("object"!=typeof t||Array.isArray(t))&&(n=t,t={}),s="string"==typeof n?[r(n)]:Array.isArray(n)?n.map(e=>"string"==typeof e?r(e):e):[],{type:e,properties:t,children:s}}const i={binding:/{\s*([^\s:}]+)(?:\s*:\s*((?:[^\s}]|\s+[^}])*))?\s*}/};class o extends class{constructor(){this._map=new Map}addEventListener(e,t,n={}){let r=this._map.get(e);r||(r=[],this._map.set(e,r));let s=!0;for(const e of r)if(e.listener===t){e.options=n,s=!1;break}return s&&r.push({listener:t,options:n}),s}removeEventListener(e,t){const n=this._map.get(e);if(n){let e=0;for(const r of n){if(r.listener===t)return n.splice(e,1),!0;e++}}return!1}async dispatchEvent(e,t={}){const n=[],r=this._map.get(e);if(r)for(const{listener:s,options:i}of[...r]){const r=s({type:e,target:this,data:{...i.data||{},...t}});n.push(r),i.once&&this.removeEventListener(e,s),i.wait&&await r}await Promise.all(n)}}{constructor(e){super(),this._parent=null,this._children=[],this._state={},this.acceptParentState=!1,this.virdNode=e instanceof o?e.virdNode:e,this.setChildren(e.children.map(e=>e instanceof o?e:new o(e))),this.addEventListener("mount",e=>{for(const t of this.children)t.dispatchEvent("unmount",{parent:e.data.parent})}),this.addEventListener("unmount",e=>{for(const t of this.children)t.dispatchEvent("unmount",{parent:e.data.parent})})}insertAfter(e,...t){const n=this.children;let r;if(e){if(r=n.indexOf(e)+1,r<1)throw Error("The VirdElement before which the new VirdElement is to be inserted is not a child of this VirdElement.")}else r=n.length;return n.splice(r,0,...t),this.setChildren(n),this.dispatchEvent("insert-children",{children:t,index:r}),this}insertBefore(e,...t){return this.insertAfter(e?e.prev:this.firstChild,...t)}appendChild(...e){return this.insertAfter(null,...e)}removeChild(...e){const t=this.children;for(const n of e)if(!t.includes(n))throw Error("The VirdElement to be removed is not a child of this VirdElement.");return this.setChildren(t.filter(t=>!e.includes(t))),this.dispatchEvent("remove-children",{children:e}),this}remove(){const e=this.parent;return e&&e.removeChild(this),this}clearChildren(){return this.setChildren([]),this}setChildren(e){const t=this.children;this._children=e,this.virdNode.children=this.children.map(e=>e.virdNode);for(const n of t)e.includes(n)||(n._parent=null,this.dispatchEvent("unmount",{parent:this}));for(const n of e)t.includes(n)||(n._parent=this,this.dispatchEvent("mount",{parent:this}));return this.update(),t}clone(e=!1){const t=n(this.virdNode,e),r=new o(t);return r.setState(this.state,!1),r}getVirdElements(e,t=!1){const n=[];t&&e(this)&&n.push(this);for(const t of this.children){e(t)&&n.push(t);const r=t.getVirdElements(e);r.length>0&&n.push(...r)}return n}update(){this.dispatchEvent("update")}setState(e,t=!0){const n=this._state;for(const t of Object.keys(e))if(this.state[t]!==e[t]){this._state=Object.assign(Object.assign({},this.state),e);break}t&&n!==this._state&&this.update()}getParentState(e=!0){const t=[this.state],n=r=>{r&&(t.push(r.state),e&&r.acceptParentState&&n(r.parent))};n(this.parent);let r={};for(const e of t)r=Object.assign(Object.assign({},e),r);return r}setAcceptParentStateOfChildren(e){for(const t of this.children)t.acceptParentState=e,t.setAcceptParentStateOfChildren(e)}get parent(){return this._parent}get children(){return[...this._children]}set children(e){this.setChildren(e)}get firstChild(){return this.children[0]||null}get lastChild(){const e=this.children;return e[e.length-1]||null}get next(){const e=this.parent;if(!e)return null;const t=e.children;return t[t.indexOf(this)+1]||null}get prev(){const e=this.parent;if(!e)return null;const t=e.children;return t[t.indexOf(this)-1]||null}get state(){return this._state}set state(e){this._state=e}get type(){return this.virdNode.type}set type(e){this.virdNode.type=e,this.update()}get properties(){let e={};const t=Object.assign({},this.virdNode.properties);if(i.binding){const n=this.getParentState(),r=(e,t,r="")=>t in n?String(n[t]):r;for(const n of Object.keys(t)){const s=t[n];e[n]=s.replace(i.binding,r)}}else e=t;return e}set properties(e){this.virdNode.properties=e,this.update()}}function d(e,n=!1,r){if("string"==typeof e)return"boolean"==typeof n&&(n={}),s(e,n,r);{const r=e,i=r.nodeName.toLocaleLowerCase(),o={};if(r instanceof Element)for(const{name:e,value:t}of r.attributes)o[e]=t;else r instanceof DocumentFragment||(o.textContent=r.textContent||"");const c=!!n;let p=[...r.childNodes].map(e=>d(e,c));if(c){const e=e=>e.type!==t.comment&&(e.type!==t.text||!/^\s*$/.test(e.properties.textContent));p=p.filter(e)}return s(i,o,p)}}class c{constructor(){this._renderMap=new Map,this._oldVirdNodeMap=new Map,this._nodeMap=new WeakMap,this._nodeCreatorMap=new WeakMap,this._propertyTypeBinderMap=new Map,this._propertyTypeRegExpBinderMap=new Map,this._customNodeCreatorMap=new Map,this.setCustomNode(t.text,()=>document.createTextNode("")),this.setCustomNode(t.comment,()=>document.createComment("")),this.setCustomNode(t.fragment,()=>document.createCDATASection("")),this.setPropertyTypeBind("textContent",(e,t)=>{e.textContent=t.newValue||""})}_updateNode(e,t,n){const r=function(e,t){const n={};if(e!==t)if(e)if(t){const r=Object.keys(e),s=Object.keys(t),i=new Set([...r,...s]);for(const r of i){const s=e[r],i=t[r];s!==i&&(n[r]=[s,i])}}else for(const t of Object.keys(e)){const r=e[t];n[t]=[r,void 0]}else if(t)for(const e of Object.keys(t)){const r=t[e];n[e]=[void 0,r]}return n}(t,n);for(const t of Object.keys(r)){const[n,s]=r[t];let i=!1;for(const[r,o]of this._propertyTypeRegExpBinderMap){const d=t.match(r);if(d){i=!0,o(e,d,{newValue:n,oldValue:s});break}}if(!i){const r=this._propertyTypeBinderMap.get(t);r?r(e,{newValue:n,oldValue:s}):e instanceof Element&&(n?e.setAttribute(t,n):e.removeAttribute(t))}}}render(e,...r){const s=r.map(t=>"function"==typeof t?t(e):t),i=function e(n){const r=[];for(const s of n)if(s.type===t.fragment){const t=e(s.children);r.push(...t)}else r.push(s);return r}(s),d=this.getChildrenVirdNode(e),c=[...e.childNodes];this._renderMap.set(e,s),this._oldVirdNodeMap.set(e,i.map(e=>n(e)));let p=0;const a=Math.max(c.length,i.length);for(;p<a;){const t=d[p]||null,n=i[p]||null,r=c[p]||null;let s=null;n?(n instanceof o&&n.addEventListener("update",()=>{this.reRender(e)}),t&&t.type===n.type?s=r:(s=this.createNode(n),r?e.replaceChild(s,r):e.appendChild(s))):r&&e.removeChild(r),s&&(this._updateNode(s,n?n.properties:void 0,t?t.properties:void 0),n&&n.children.length>0&&this.render(s,...n.children)),p++}return i}renderDom(e,t=!1){const n=d(e,t).children;return this.render(e,...n)}reRender(e){const t=this._renderMap.get(e);t&&this.render(e,...t)}createDispatcher(e){return async t=>{t&&await t(),this.reRender(e)}}createEffect(e,t,n){const r=this.createDispatcher(e);return{value:n,setEffect(e){r(async()=>{this.value=await t(e)})}}}createNode(e){let t;const n=this._nodeMap.get(e);n&&(t=n);const r=t?this._nodeCreatorMap.get(t):void 0,s=this._customNodeCreatorMap.get(e.type);return r!==s&&s&&(t=s(e)),t||(t=document.createElement(e.type)),this._nodeMap.set(e,t),t}clone(){const e=new c;for(const[t,n]of this._propertyTypeRegExpBinderMap)e.setPropertyTypeRegExpBind(t,n);for(const[t,n]of this._propertyTypeBinderMap)e.setPropertyTypeBind(t,n)}getNode(e){return this._nodeMap.get(e)||null}getChildrenVirdNode(e){return this._oldVirdNodeMap.get(e)||[]}setCustomNode(e,t){return this._customNodeCreatorMap.set(e,t),this}removeCustomNode(e){return this._customNodeCreatorMap.delete(e),this}setPropertyTypeRegExpBind(e,t){return this.removePropertyTypeRegExpBind(e),this._propertyTypeRegExpBinderMap.set(e,t),this}removePropertyTypeRegExpBind(e){for(const t of this._propertyTypeRegExpBinderMap.keys())if(String(t)===String(e)){this._propertyTypeRegExpBinderMap.delete(e);break}return this}setPropertyTypeBind(e,t){return this._propertyTypeBinderMap.set(e,t),this}removePropertyTypeBind(e){return this._propertyTypeBinderMap.delete(e),this}}const p=new c;e.Renderer=c,e.VirdElement=o,e.cloneVirdNode=n,e.config=i,e.createElement=function(e,t,n){const r=d(e,t,n);return new o(r)},e.createNode=d,e.createVirdComment=function(e=""){return{type:t.comment,properties:{textContent:e},children:[]}},e.createVirdFragment=function(...e){return{type:t.fragment,properties:{},children:e}},e.createVirdNode=s,e.createVirdText=r,e.renderer=p,e.virdNodeTypes=t,Object.defineProperty(e,"__esModule",{value:!0})}));
