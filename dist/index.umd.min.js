!function(e,t){"object"==typeof exports&&"undefined"!=typeof module?t(exports):"function"==typeof define&&define.amd?define(["exports"],t):t((e=e||self).vird={})}(this,(function(e){"use strict";const t=Object.defineProperties({},{text:{value:"#text"},comment:{value:"#comment"},fragment:{value:"#document-fragment"}});function r(e,n=!1){return{type:t.text,properties:Object.assign({},e.properties),children:n?e.children.map(e=>r(e)):[]}}function n(e){return{type:t.text,properties:{textContent:e},children:[]}}function i(e,t,r){("object"!=typeof t||Array.isArray(t))&&(r=t,t={}),"string"==typeof r?r=[r]:Array.isArray(r)||(r=[]);return{type:e,properties:t,children:r.map(e=>"string"==typeof e?n(e):e)}}class s extends class{constructor(){this._map=new Map}addEventListener(e,t,r={}){let n=this._map.get(e);n||(n=[],this._map.set(e,n));let i=!0;for(const e of n)if(e.listener===t){e.options=r,i=!1;break}return i&&n.push({listener:t,options:r}),i}removeEventListener(e,t){const r=this._map.get(e);if(r){let e=0;for(const n of r){if(n.listener===t)return r.splice(e,1),!0;e++}}return!1}async dispatchEvent(e,t={}){const r=[],n=this._map.get(e);if(n)for(const{listener:i,options:s}of[...n]){const n=i({type:e,target:this,data:{...s.data||{},...t}});r.push(n),s.once&&this.removeEventListener(e,i),s.wait&&await n}await Promise.all(r)}}{constructor(e){super(),this._parent=null,this.state={},this.virdNode=e,this._children=e.children.map(e=>new s(e)),this.addEventListener("mount",e=>{for(const t of this.children)t.dispatchEvent("unmount",{parent:e.data.parent})}),this.addEventListener("unmount",e=>{for(const t of this.children)t.dispatchEvent("unmount",{parent:e.data.parent})})}insertAfter(e,...t){const r=this.children;let n;if(e){if(n=r.indexOf(e)+1,n<1)throw Error("The VirdElement before which the new VirdElement is to be inserted is not a child of this VirdElement.")}else n=r.length;return r.splice(n,0,...t),this.setChildren(r),this.dispatchEvent("insert-children",{children:t,index:n}),this}insertBefore(e,...t){return this.insertAfter(e?e.prev:this.firstChild,...t)}appendChild(...e){return this.insertAfter(null,...e)}removeChild(...e){const t=this.children;for(const r of e)if(!t.includes(r))throw Error("The VirdElement to be removed is not a child of this VirdElement.");return this.setChildren(t.filter(t=>!e.includes(t))),this.dispatchEvent("remove-children",{children:e}),this}remove(){const e=this.parent;return e&&e.removeChild(this),this}clearChildren(){return this.setChildren([]),this}setChildren(e){const t=this.children;this._children=e,this.virdNode.children=this.children.map(e=>e.virdNode);for(const r of t)e.includes(r)||(r._parent=null,this.dispatchEvent("unmount",{parent:this}));for(const r of e)t.includes(r)||(r._parent=this,this.dispatchEvent("mount",{parent:this}));return this.update(),t}clone(e=!1){const t=r(this.virdNode,e),n=new s(t);return n.setState(this.state,!1),n}getVirdElements(e,t=!1){const r=[];t&&e(this)&&r.push(this);for(const t of this.children)e(t)&&r.push(t);return r}update(){this.dispatchEvent("update")}setState(e,t=!0){const r=this.state;for(const t of Object.keys(e))if(this.state[t]!==e[t]){this.state=Object.assign(Object.assign({},this.state),e);break}t&&r!==this.state&&this.update()}get parent(){return this._parent}get children(){return[...this._children]}set children(e){this.setChildren(e)}get firstChild(){return this.children[0]||null}get lastChild(){const e=this.children;return e[e.length-1]||null}get next(){const e=this.parent;if(!e)return null;const t=e.children;return t[t.indexOf(this)+1]||null}get prev(){const e=this.parent;if(!e)return null;const t=e.children;return t[t.indexOf(this)-1]||null}get type(){return this.virdNode.type}set type(e){this.virdNode.type=e,this.update()}get properties(){return Object.assign({},this.virdNode.properties)}set properties(e){this.virdNode.properties=e,this.update()}}function o(e,r=!1,n){if("string"==typeof e)return"boolean"==typeof r&&(r={}),i(e,r,n);{const n=e,s=n.nodeName.toLocaleLowerCase(),d={};if(n instanceof Element)for(const{name:e,value:t}of n.attributes)d[e]=t;else d.textContent=n.textContent||"";const p=!!r;let h=[...n.childNodes].map(e=>o(e,p));if(p){const e=e=>e.type!==t.comment&&(e.type!==t.text||!/^\s*$/.test(e.properties.textContent));h=h.filter(e)}return i(s,d,h)}}class d{constructor(){this._renderMap=new Map,this._oldVirdNodeMap=new Map,this._nodeMap=new WeakMap,this._virdNodeMap=new WeakMap,this._nodeCreatorMap=new WeakMap,this._propertyTypeBinderMap=new Map,this._propertyTypeRegExpBinderMap=new Map,this._customNodeCreatorMap=new Map,this.fragmentType="#document-fragment",this.setCustomNode("#text",()=>document.createTextNode("")),this.setCustomNode("#comment",()=>document.createComment("")),this.setCustomNode("#cdata-section",()=>document.createCDATASection("")),this.setPropertyTypeBind("textContent",(e,t)=>{e.textContent=t.newValue||""})}_updateNode(e,t,r){const n=function(e,t){const r={};if(e!==t)if(e)if(t){const n=Object.keys(e),i=Object.keys(t),s=new Set([...n,...i]);for(const n of s){const i=e[n],s=t[n];i!==s&&(r[n]=[i,s])}}else for(const t of Object.keys(e)){const n=e[t];r[t]=[n,void 0]}else if(t)for(const e of Object.keys(t)){const n=t[e];r[e]=[void 0,n]}return r}(t,r);for(const t of Object.keys(n)){const[r,i]=n[t];let s=!1;for(const[n,o]of this._propertyTypeRegExpBinderMap){const d=t.match(n);if(d){s=!0,o(e,d,{newValue:r,oldValue:i});break}}if(!s){const n=this._propertyTypeBinderMap.get(t);n?n(e,{newValue:r,oldValue:i}):e instanceof Element&&(r?e.setAttribute(t,r):e.removeAttribute(t))}}}render(e,...t){const r=function e(t,r="#document-fragment"){const n=[];for(const i of t)if(i.type===r){const t=e(i.children);n.push(...t)}else n.push(i);return n}(t.map(t=>"function"==typeof t?t(e):t)),n=this.getChildrenVirdNode(e),i=[...e.childNodes];this._renderMap.set(e,t),this._oldVirdNodeMap.set(e,r);let s=0;const o=Math.max(i.length,r.length);for(;s<o;){const t=n[s]||null,o=r[s]||null,d=i[s]||null;let p=null;o?t&&t.type===o.type?p=d:(p=this.createNode(o),d?e.replaceChild(p,d):e.appendChild(p)):d&&e.removeChild(d),p&&(this._updateNode(p,o?o.properties:void 0,t?t.properties:void 0),o&&o.children.length>0&&this.render(p,...o.children)),s++}return r}renderDom(e,t=!1){const r=o(e,t).children;return this.render(e,...r)}reRender(e){const t=this._renderMap.get(e);t&&this.render(e,...t)}createDispatcher(e){return async t=>{t&&await t(),this.reRender(e)}}createEffect(e,t,r){const n=this.createDispatcher(e);return{value:r,setEffect(e){n(async()=>{this.value=await t(e)})}}}createNode(e){let t;const r=this._nodeMap.get(e);r&&(t=r);const n=t?this._nodeCreatorMap.get(t):void 0,i=this._customNodeCreatorMap.get(e.type);return n!==i&&i&&(t=i(e)),t||(t=document.createElement(e.type)),this._nodeMap.set(e,t),this._virdNodeMap.set(t,e),t}clone(){const e=new d;for(const[t,r]of this._propertyTypeRegExpBinderMap)e.setPropertyTypeRegExpBind(t,r);for(const[t,r]of this._propertyTypeBinderMap)e.setPropertyTypeBind(t,r)}getNode(e){return this._nodeMap.get(e)||null}getVirdNode(e){return this._virdNodeMap.get(e)||null}getChildrenVirdNode(e){return this._oldVirdNodeMap.get(e)||[]}setCustomNode(e,t){return this._customNodeCreatorMap.set(e,t),this}removeCustomNode(e){return this._customNodeCreatorMap.delete(e),this}setPropertyTypeRegExpBind(e,t){return this.removePropertyTypeRegExpBind(e),this._propertyTypeRegExpBinderMap.set(e,t),this}removePropertyTypeRegExpBind(e){for(const t of this._propertyTypeRegExpBinderMap.keys())if(String(t)===String(e)){this._propertyTypeRegExpBinderMap.delete(e);break}return this}setPropertyTypeBind(e,t){return this._propertyTypeBinderMap.set(e,t),this}removePropertyTypeBind(e){return this._propertyTypeBinderMap.delete(e),this}}const p=new d;e.Renderer=d,e.VirdElement=s,e.cloneVirdNode=r,e.createComment=function(e){return{type:t.comment,properties:{textContent:e},children:[]}},e.createFragment=function(...e){return{type:t.fragment,properties:{},children:e}},e.createNode=o,e.createText=n,e.createVirdNode=i,e.renderer=p,e.virdNodeTypes=t,Object.defineProperty(e,"__esModule",{value:!0})}));
