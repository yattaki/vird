"use strict";Object.defineProperty(exports,"__esModule",{value:!0});const e=Object.defineProperties({},{text:{value:"#text"},comment:{value:"#comment"},fragment:{value:"#document-fragment"}});function t(t){return{type:e.text,properties:{textContent:t},children:[]}}function r(e,r,o){("object"!=typeof r||Array.isArray(r))&&(o=r,r={}),"string"==typeof o?o=[o]:Array.isArray(o)||(o=[]);return{type:e,properties:r,children:o.map(e=>"string"==typeof e?t(e):e)}}function o(t,n=!1,s){if("string"==typeof t)return"boolean"==typeof n&&(n={}),r(t,n,s);{const s=t,p=s.nodeName.toLocaleLowerCase(),i={};if(s instanceof Element)for(const{name:e,value:t}of s.attributes)i[e]=t;else i.textContent=s.textContent||"";const d=!!n;let a=[...s.childNodes].map(e=>o(e,d));if(d){const t=t=>t.type!==e.comment&&(t.type!==e.text||!/^\s*$/.test(t.properties.textContent));a=a.filter(t)}return r(p,i,a)}}class n{constructor(){this._renderMap=new Map,this._oldVirdNodeMap=new Map,this._nodeMap=new WeakMap,this._virdNodeMap=new WeakMap,this._nodeCreatorMap=new WeakMap,this._propertyTypeBinderMap=new Map,this._propertyTypeRegExpBinderMap=new Map,this._customNodeCreatorMap=new Map,this.fragmentType="#document-fragment",this.setCustomNode("#text",()=>document.createTextNode("")),this.setCustomNode("#comment",()=>document.createComment("")),this.setCustomNode("#cdata-section",()=>document.createCDATASection("")),this.setPropertyTypeBind("textContent",(e,t)=>{e.textContent=t.newValue||""})}_updateNode(e,t,r){const o=function(e,t){const r={};if(e!==t)if(e)if(t){const o=Object.keys(e),n=Object.keys(t),s=new Set([...o,...n]);for(const o of s){const n=e[o],s=t[o];n!==s&&(r[o]=[n,s])}}else for(const t of Object.keys(e)){const o=e[t];r[t]=[o,void 0]}else if(t)for(const e of Object.keys(t)){const o=t[e];r[e]=[void 0,o]}return r}(t,r);for(const t of Object.keys(o)){const[r,n]=o[t];let s=!1;for(const[o,p]of this._propertyTypeRegExpBinderMap){const i=t.match(o);if(i){s=!0,p(e,i,{newValue:r,oldValue:n});break}}if(!s){const o=this._propertyTypeBinderMap.get(t);o?o(e,{newValue:r,oldValue:n}):e instanceof Element&&(r?e.setAttribute(t,r):e.removeAttribute(t))}}}render(e,...t){const r=function e(t,r="#document-fragment"){const o=[];for(const n of t)if(n.type===r){const t=e(n.children);o.push(...t)}else o.push(n);return o}(t.map(t=>"function"==typeof t?t(e):t)),o=this.getChildrenVirdNode(e),n=[...e.childNodes];this._renderMap.set(e,t),this._oldVirdNodeMap.set(e,r);let s=0;const p=Math.max(n.length,r.length);for(;s<p;){const t=o[s]||null,p=r[s]||null,i=n[s]||null;let d=null;p?t&&t.type===p.type?d=i:(d=this.createNode(p),i?e.replaceChild(d,i):e.appendChild(d)):i&&e.removeChild(i),d&&(this._updateNode(d,p?p.properties:void 0,t?t.properties:void 0),p&&p.children.length>0&&this.render(d,...p.children)),s++}return r}renderDom(e,t=!1){const r=o(e,t).children;return this.render(e,...r)}reRender(e){const t=this._renderMap.get(e);t&&this.render(e,...t)}createDispatcher(e){return async t=>{t&&await t(),this.reRender(e)}}createEffect(e,t,r){const o=this.createDispatcher(e);return{value:r,setEffect(e){o(async()=>{this.value=await t(e)})}}}createNode(e){let t;const r=this._nodeMap.get(e);r&&(t=r);const o=t?this._nodeCreatorMap.get(t):void 0,n=this._customNodeCreatorMap.get(e.type);return o!==n&&n&&(t=n(e)),t||(t=document.createElement(e.type)),this._nodeMap.set(e,t),this._virdNodeMap.set(t,e),t}clone(){const e=new n;for(const[t,r]of this._propertyTypeRegExpBinderMap)e.setPropertyTypeRegExpBind(t,r);for(const[t,r]of this._propertyTypeBinderMap)e.setPropertyTypeBind(t,r)}getNode(e){return this._nodeMap.get(e)||null}getVirdNode(e){return this._virdNodeMap.get(e)||null}getChildrenVirdNode(e){return this._oldVirdNodeMap.get(e)||[]}setCustomNode(e,t){return this._customNodeCreatorMap.set(e,t),this}removeCustomNode(e){return this._customNodeCreatorMap.delete(e),this}setPropertyTypeRegExpBind(e,t){return this.removePropertyTypeRegExpBind(e),this._propertyTypeRegExpBinderMap.set(e,t),this}removePropertyTypeRegExpBind(e){for(const t of this._propertyTypeRegExpBinderMap.keys())if(String(t)===String(e)){this._propertyTypeRegExpBinderMap.delete(e);break}return this}setPropertyTypeBind(e,t){return this._propertyTypeBinderMap.set(e,t),this}removePropertyTypeBind(e){return this._propertyTypeBinderMap.delete(e),this}}const s=new n;exports.Renderer=n,exports.createComment=function(t){return{type:e.comment,properties:{textContent:t},children:[]}},exports.createFragment=function(...t){return{type:e.fragment,properties:{},children:t}},exports.createNode=o,exports.createText=t,exports.createVirdNode=r,exports.renderer=s,exports.virdNodeTypes=e;
